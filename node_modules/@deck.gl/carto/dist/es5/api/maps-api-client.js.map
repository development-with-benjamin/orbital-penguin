{"version":3,"sources":["../../../src/api/maps-api-client.js"],"names":["DEFAULT_USER_COMPONENT_IN_URL","DEFAULT_REGION_COMPONENT_IN_URL","MAP_TYPES","SQL","TABLE","TILESET","CONNECTIONS","BIGQUERY","CARTO","getTileJSON","connection","type","source","mapConfig","credentials","creds","url","buildURL","request","layergroup","metadata","tilejson","vector","Error","fetch","headers","Accept","response","json","ok","dealWithError","status","username","apiKey","e","JSON","stringify","errors","error","encodedApiKey","encodeParameter","encodedClient","parameters","cfg","mapsUrl","join","replace","region","name","value","encodeURIComponent"],"mappings":"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","sourcesContent":["import {getDefaultCredentials, getMapsVersion} from '../config';\n\nconst DEFAULT_USER_COMPONENT_IN_URL = '{user}';\nconst DEFAULT_REGION_COMPONENT_IN_URL = '{region}';\n\nexport const MAP_TYPES = {\n  SQL: 'sql',\n  TABLE: 'table',\n  TILESET: 'tileset'\n};\n\nexport const CONNECTIONS = {\n  BIGQUERY: 'bigquery',\n  CARTO: 'carto'\n};\n\n/**\n * Obtain a TileJson from Maps API v1 and v2\n */\nexport async function getTileJSON({connection, type, source, mapConfig, credentials}) {\n  const creds = {...getDefaultCredentials(), ...credentials};\n  let url;\n\n  switch (getMapsVersion(creds)) {\n    case 'v1':\n      // Maps API v1\n      url = buildURL({mapConfig, credentials: creds});\n      const layergroup = await request({url, credentials: creds});\n      return layergroup.metadata.tilejson.vector;\n\n    case 'v2':\n      // Maps API v2\n      url = buildURL({connection, type, source, credentials: creds});\n      return await request({url, credentials: creds});\n\n    default:\n      throw new Error('Invalid maps API version. It shoud be v1 or v2');\n  }\n}\n\n/**\n * Request against Maps API\n */\nasync function request({url, credentials}) {\n  let response;\n\n  try {\n    /* global fetch */\n    /* eslint no-undef: \"error\" */\n    response = await fetch(url, {\n      headers: {\n        Accept: 'application/json'\n      }\n    });\n  } catch (error) {\n    throw new Error(`Failed to connect to Maps API: ${error}`);\n  }\n\n  const json = await response.json();\n\n  if (!response.ok) {\n    dealWithError({response, json, credentials});\n  }\n\n  return json;\n}\n\n/**\n * Display proper message from Maps API error\n */\nfunction dealWithError({response, json, credentials}) {\n  switch (response.status) {\n    case 401:\n      throw new Error(\n        `Unauthorized access to Maps API: invalid combination of user ('${\n          credentials.username\n        }') and apiKey ('${credentials.apiKey}')`\n      );\n    case 403:\n      throw new Error(\n        `Unauthorized access to dataset: the provided apiKey('${\n          credentials.apiKey\n        }') doesn't provide access to the requested data`\n      );\n\n    default:\n      const e = getMapsVersion() === 'v1' ? JSON.stringify(json.errors) : json.error;\n      throw new Error(e);\n  }\n}\n\n/**\n * Build a URL with all required parameters\n */\nfunction buildURL({connection, type, source, mapConfig, credentials}) {\n  const encodedApiKey = encodeParameter('api_key', credentials.apiKey);\n  const encodedClient = encodeParameter('client', `deck-gl-carto`);\n  const parameters = [encodedApiKey, encodedClient];\n\n  if (mapConfig) {\n    const cfg = JSON.stringify(mapConfig);\n    return `${mapsUrl(credentials)}?${parameters.join('&')}&${encodeParameter('config', cfg)}`;\n  }\n  let url = `${mapsUrl(credentials)}/${connection}/${type}?`;\n  url += `${encodeParameter('source', source)}&format=tilejson&${parameters.join('&')}`;\n  return url;\n}\n\n/**\n * Prepare a url valid for the specified user\n */\nfunction mapsUrl(credentials) {\n  return credentials.mapsUrl\n    .replace(DEFAULT_USER_COMPONENT_IN_URL, credentials.username)\n    .replace(DEFAULT_REGION_COMPONENT_IN_URL, credentials.region);\n}\n\n/**\n * Simple encode parameter\n */\nfunction encodeParameter(name, value) {\n  return `${name}=${encodeURIComponent(value)}`;\n}\n"],"file":"maps-api-client.js"}