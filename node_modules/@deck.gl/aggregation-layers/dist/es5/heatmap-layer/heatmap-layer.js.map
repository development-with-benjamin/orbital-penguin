{"version":3,"sources":["../../../src/heatmap-layer/heatmap-layer.js"],"names":["RESOLUTION","SIZE_2K","ZOOM_DEBOUNCE","TEXTURE_OPTIONS","mipmaps","parameters","dataFormat","DEFAULT_COLOR_DOMAIN","AGGREGATION_MODE","SUM","MEAN","defaultProps","getPosition","type","value","x","position","getWeight","intensity","min","radiusPixels","max","colorRange","defaultColorRange","threshold","colorDomain","optional","aggregation","REQUIRED_FEATURES","FEATURES","BLEND_EQUATION_MINMAX","TEXTURE_FLOAT","DIMENSIONS","data","props","HeatmapLayer","gl","context","setState","supported","log","error","id","_setupTextureParams","_setupAttributes","_setupResources","changeFlags","somethingChanged","opts","state","oldProps","_getChangeFlags","viewportChanged","boundsChanged","_updateBounds","_updateTextureRenderingBounds","dataChanged","clearTimeout","updateTimer","isWeightMapDirty","viewportZoomChanged","_debouncedUpdateWeightmap","_updateColorTexture","viewport","weightsScale","domainScale","scale","map","Math","_updateWeightmap","zoom","weightsTexture","triPositionBuffer","triTexCoordBuffer","maxWeightsTexture","colorTexture","updateTriggers","TriangleLayerClass","getSubLayerClass","TriangleLayer","getSubLayerProps","coordinateSystem","COORDINATE_SYSTEM","DEFAULT","attributes","positions","texCoords","vertexCount","maxTexture","aggregationMode","texture","weightsTransform","maxWeightTransform","AttributeManager","stats","dimensions","isAttributeChanged","isAggregationDirty","compareAll","dimension","textureSize","format","Texture2D","width","height","attributeManager","getAttributeManager","add","size","accessor","weights","positionAttributeName","floatTargetSupport","COLOR_ATTACHMENT_RGBA32F","warn","shaderOptions","shaders","vs","weights_vs","_fs","weights_fs","Transform","elementCount","_targetTexture","_targetTextureVarying","_createTextures","_createWeightsTransform","_sourceTextures","inTexture","vs_max","fs_max","Buffer","byteLength","run","blend","depthTest","blendFunc","blendEquation","forceUpdate","viewportCorners","unproject","p","fround","visibleWorldBounds","newState","worldBounds","scaledCommonBounds","_worldToCommonBounds","_commonToWorldBounds","LNGLAT","normalizedCommonBounds","subData","textureBounds","projectPosition","colors","Uint8Array","setImageData","length","commonBounds","useLayerCoordinateSystem","uniforms","textureWidth","update","getNumInstances","clearRenderTarget","getAttributes","moduleSettings","getModuleSettings","_updateMaxWeightValue","setParameters","fromTimer","setTimeout","bind","minLong","minLat","maxLong","maxLat","offsetMode","LNGLAT_OFFSETS","METER_OFFSETS","offsetOriginCommon","coordinateOrigin","bottomLeftCommon","topRightCommon","xMin","yMin","xMax","yMax","bottomLeftWorld","unprojectPosition","topRightWorld","slice","concat","AggregationLayer","layerName"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAsBA;;AAQA;;AACA;;AAMA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;;;;;;;AAEA,IAAMA,UAAU,GAAG,CAAnB;AACA,IAAMC,OAAO,GAAG,IAAhB;AACA,IAAMC,aAAa,GAAG,GAAtB;AACA,IAAMC,eAAe,GAAG;AACtBC,EAAAA,OAAO,EAAE,KADa;AAEtBC,EAAAA,UAAU,mRAFY;AAQtBC,EAAAA,UAAU;AARY,CAAxB;AAUA,IAAMC,oBAAoB,GAAG,CAAC,CAAD,EAAI,CAAJ,CAA7B;AACA,IAAMC,gBAAgB,GAAG;AACvBC,EAAAA,GAAG,EAAE,CADkB;AAEvBC,EAAAA,IAAI,EAAE;AAFiB,CAAzB;AAKA,IAAMC,YAAY,GAAG;AACnBC,EAAAA,WAAW,EAAE;AAACC,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE,eAAAC,CAAC;AAAA,aAAIA,CAAC,CAACC,QAAN;AAAA;AAA3B,GADM;AAEnBC,EAAAA,SAAS,EAAE;AAACJ,IAAAA,IAAI,EAAE,UAAP;AAAmBC,IAAAA,KAAK,EAAE;AAA1B,GAFQ;AAGnBI,EAAAA,SAAS,EAAE;AAACL,IAAAA,IAAI,EAAE,QAAP;AAAiBM,IAAAA,GAAG,EAAE,CAAtB;AAAyBL,IAAAA,KAAK,EAAE;AAAhC,GAHQ;AAInBM,EAAAA,YAAY,EAAE;AAACP,IAAAA,IAAI,EAAE,QAAP;AAAiBM,IAAAA,GAAG,EAAE,CAAtB;AAAyBE,IAAAA,GAAG,EAAE,GAA9B;AAAmCP,IAAAA,KAAK,EAAE;AAA1C,GAJK;AAKnBQ,EAAAA,UAAU,EAAEC,6BALO;AAMnBC,EAAAA,SAAS,EAAE;AAACX,IAAAA,IAAI,EAAE,QAAP;AAAiBM,IAAAA,GAAG,EAAE,CAAtB;AAAyBE,IAAAA,GAAG,EAAE,CAA9B;AAAiCP,IAAAA,KAAK,EAAE;AAAxC,GANQ;AAOnBW,EAAAA,WAAW,EAAE;AAACZ,IAAAA,IAAI,EAAE,OAAP;AAAgBC,IAAAA,KAAK,EAAE,IAAvB;AAA6BY,IAAAA,QAAQ,EAAE;AAAvC,GAPM;AASnBC,EAAAA,WAAW,EAAE;AATM,CAArB;AAYA,IAAMC,iBAAiB,GAAG,CACxBC,eAASC,qBADe,EAExBD,eAASE,aAFe,CAA1B;AAMA,IAAMC,UAAU,GAAG;AACjBC,EAAAA,IAAI,EAAE;AACJC,IAAAA,KAAK,EAAE,CAAC,cAAD;AADH;AADW,CAAnB;;IAMqBC,Y;;;;;;;;;;;;sCACD;AAAA,UACTC,EADS,GACH,KAAKC,OADF,CACTD,EADS;;AAEhB,UAAI,CAAC,uBAAYA,EAAZ,EAAgBR,iBAAhB,CAAL,EAAyC;AACvC,aAAKU,QAAL,CAAc;AAACC,UAAAA,SAAS,EAAE;AAAZ,SAAd;;AACAC,mBAAIC,KAAJ,yBAA2B,KAAKC,EAAhC;;AACA;AACD;;AACD,0HAAsBV,UAAtB;AACA,WAAKM,QAAL,CAAc;AAACC,QAAAA,SAAS,EAAE;AAAZ,OAAd;;AACA,WAAKI,mBAAL;;AACA,WAAKC,gBAAL;;AACA,WAAKC,eAAL;AACD;;;4CAEgC;AAAA,UAAdC,WAAc,QAAdA,WAAc;AAE/B,aAAOA,WAAW,CAACC,gBAAnB;AACD;;;gCAGWC,I,EAAM;AAChB,UAAI,CAAC,KAAKC,KAAL,CAAWV,SAAhB,EAA2B;AACzB;AACD;;AACD,sHAAkBS,IAAlB;AAJgB,UAKTd,KALS,GAKUc,IALV,CAKTd,KALS;AAAA,UAKFgB,QALE,GAKUF,IALV,CAKFE,QALE;;AAMhB,UAAMJ,WAAW,GAAG,KAAKK,eAAL,CAAqBH,IAArB,CAApB;;AAEA,UAAIF,WAAW,CAACM,eAAhB,EAAiC;AAC/BN,QAAAA,WAAW,CAACO,aAAZ,GAA4B,KAAKC,aAAL,EAA5B;;AACA,aAAKC,6BAAL;AACD;;AAED,UAAIT,WAAW,CAACU,WAAZ,IAA2BV,WAAW,CAACO,aAA3C,EAA0D;AAExDI,QAAAA,YAAY,CAAC,KAAKR,KAAL,CAAWS,WAAZ,CAAZ;AACA,aAAKpB,QAAL,CAAc;AAACqB,UAAAA,gBAAgB,EAAE;AAAnB,SAAd;AACD,OAJD,MAIO,IAAIb,WAAW,CAACc,mBAAhB,EAAqC;AAE1C,aAAKC,yBAAL;AACD;;AAED,UAAI3B,KAAK,CAACZ,UAAN,KAAqB4B,QAAQ,CAAC5B,UAAlC,EAA8C;AAC5C,aAAKwC,mBAAL,CAAyBd,IAAzB;AACD;;AAED,UAAIE,QAAQ,CAACzB,WAAT,KAAyBS,KAAK,CAACT,WAA/B,IAA8CqB,WAAW,CAACM,eAA9D,EAA+E;AAAA,YACtEW,QADsE,GAC1D,KAAK1B,OADqD,CACtE0B,QADsE;AAAA,YAEtEC,YAFsE,GAEtD,KAAKf,KAFiD,CAEtEe,YAFsE;AAG7E,YAAMC,WAAW,GAAG,CAACF,QAAQ,GAAG,OAAOA,QAAQ,CAACG,KAAnB,GAA2B,CAApC,IAAyCF,YAA7D;AACA,YAAMvC,WAAW,GAAGS,KAAK,CAACT,WAAN,GAChBS,KAAK,CAACT,WAAN,CAAkB0C,GAAlB,CAAsB,UAAApD,CAAC;AAAA,iBAAIA,CAAC,GAAGkD,WAAR;AAAA,SAAvB,CADgB,GAEhB1D,oBAFJ;;AAGA,YAAIkB,WAAW,CAAC,CAAD,CAAX,GAAiB,CAAjB,IAAsBuC,YAAY,GAAG,CAAzC,EAA4C;AAG1C,cAAM3C,GAAG,GAAG+C,IAAI,CAACjD,GAAL,CAASM,WAAW,CAAC,CAAD,CAApB,EAAyB,CAAzB,CAAZ;AACAA,UAAAA,WAAW,CAAC,CAAD,CAAX,IAAkBJ,GAAG,GAAGI,WAAW,CAAC,CAAD,CAAnC;AACAA,UAAAA,WAAW,CAAC,CAAD,CAAX,GAAiBJ,GAAjB;AACD;;AACD,aAAKiB,QAAL,CAAc;AAACb,UAAAA,WAAW,EAAXA;AAAD,SAAd;AACD;;AAED,UAAI,KAAKwB,KAAL,CAAWU,gBAAf,EAAiC;AAC/B,aAAKU,gBAAL;AACD;;AAED,WAAK/B,QAAL,CAAc;AAACgC,QAAAA,IAAI,EAAEtB,IAAI,CAACX,OAAL,CAAa0B,QAAb,CAAsBO;AAA7B,OAAd;AACD;;;mCAGc;AACb,UAAI,CAAC,KAAKrB,KAAL,CAAWV,SAAhB,EAA2B;AACzB,eAAO,EAAP;AACD;;AAHY,wBAWT,KAAKU,KAXI;AAAA,UAKXsB,cALW,eAKXA,cALW;AAAA,UAMXC,iBANW,eAMXA,iBANW;AAAA,UAOXC,iBAPW,eAOXA,iBAPW;AAAA,UAQXC,iBARW,eAQXA,iBARW;AAAA,UASXC,YATW,eASXA,YATW;AAAA,UAUXlD,WAVW,eAUXA,WAVW;AAAA,wBAY+C,KAAKS,KAZpD;AAAA,UAYN0C,cAZM,eAYNA,cAZM;AAAA,UAYU1D,SAZV,eAYUA,SAZV;AAAA,UAYqBM,SAZrB,eAYqBA,SAZrB;AAAA,UAYgCG,WAZhC,eAYgCA,WAZhC;AAcb,UAAMkD,kBAAkB,GAAG,KAAKC,gBAAL,CAAsB,UAAtB,EAAkCC,yBAAlC,CAA3B;AAEA,aAAO,IAAIF,kBAAJ,CACL,KAAKG,gBAAL,CAAsB;AACpBtC,QAAAA,EAAE,EAAE,gBADgB;AAEpBkC,QAAAA,cAAc,EAAdA;AAFoB,OAAtB,CADK,EAKL;AAGEK,QAAAA,gBAAgB,EAAEC,yBAAkBC,OAHtC;AAIElD,QAAAA,IAAI,EAAE;AACJmD,UAAAA,UAAU,EAAE;AACVC,YAAAA,SAAS,EAAEb,iBADD;AAEVc,YAAAA,SAAS,EAAEb;AAFD;AADR,SAJR;AAUEc,QAAAA,WAAW,EAAE,CAVf;AAWEC,QAAAA,UAAU,EAAEd,iBAXd;AAYEC,QAAAA,YAAY,EAAZA,YAZF;AAaEc,QAAAA,eAAe,EAAEjF,gBAAgB,CAACmB,WAAD,CAAhB,IAAiC,CAbpD;AAcE+D,QAAAA,OAAO,EAAEnB,cAdX;AAeErD,QAAAA,SAAS,EAATA,SAfF;AAgBEM,QAAAA,SAAS,EAATA,SAhBF;AAiBEC,QAAAA,WAAW,EAAXA;AAjBF,OALK,CAAP;AAyBD;;;oCAEe;AACd;AADc,yBAWV,KAAKwB,KAXK;AAAA,UAGZ0C,gBAHY,gBAGZA,gBAHY;AAAA,UAIZpB,cAJY,gBAIZA,cAJY;AAAA,UAKZqB,kBALY,gBAKZA,kBALY;AAAA,UAMZlB,iBANY,gBAMZA,iBANY;AAAA,UAOZF,iBAPY,gBAOZA,iBAPY;AAAA,UAQZC,iBARY,gBAQZA,iBARY;AAAA,UASZE,YATY,gBASZA,YATY;AAAA,UAUZjB,WAVY,gBAUZA,WAVY;AAadiC,MAAAA,gBAAgB,IAAIA,gBAAgB,UAAhB,EAApB;AACApB,MAAAA,cAAc,IAAIA,cAAc,UAAd,EAAlB;AACAqB,MAAAA,kBAAkB,IAAIA,kBAAkB,UAAlB,EAAtB;AACAlB,MAAAA,iBAAiB,IAAIA,iBAAiB,UAAjB,EAArB;AACAF,MAAAA,iBAAiB,IAAIA,iBAAiB,UAAjB,EAArB;AACAC,MAAAA,iBAAiB,IAAIA,iBAAiB,UAAjB,EAArB;AACAE,MAAAA,YAAY,IAAIA,YAAY,UAAZ,EAAhB;AACAjB,MAAAA,WAAW,IAAID,YAAY,CAACC,WAAD,CAA3B;AAED;;;2CAKsB;AACrB,aAAO,IAAImC,uBAAJ,CAAqB,KAAKxD,OAAL,CAAaD,EAAlC,EAAsC;AAC3CM,QAAAA,EAAE,EAAE,KAAKR,KAAL,CAAWQ,EAD4B;AAE3CoD,QAAAA,KAAK,EAAE,KAAKzD,OAAL,CAAayD;AAFuB,OAAtC,CAAP;AAID;;;oCAEe9C,I,EAAM;AACpB,UAAMF,WAAW,GAAG,EAApB;AADoB,UAEbiD,UAFa,GAEC,KAAK9C,KAFN,CAEb8C,UAFa;AAGpBjD,MAAAA,WAAW,CAACU,WAAZ,GACE,KAAKwC,kBAAL,MACA,KAAKC,kBAAL,CAAwBjD,IAAxB,EAA8B;AAC5BkD,QAAAA,UAAU,EAAE,IADgB;AAE5BC,QAAAA,SAAS,EAAEJ,UAAU,CAAC9D;AAFM,OAA9B,CAFF;AAMAa,MAAAA,WAAW,CAACM,eAAZ,GAA8BJ,IAAI,CAACF,WAAL,CAAiBM,eAA/C;AAToB,UAWbkB,IAXa,GAWL,KAAKrB,KAXA,CAWbqB,IAXa;;AAYpB,UAAI,CAACtB,IAAI,CAACX,OAAL,CAAa0B,QAAd,IAA0Bf,IAAI,CAACX,OAAL,CAAa0B,QAAb,CAAsBO,IAAtB,KAA+BA,IAA7D,EAAmE;AACjExB,QAAAA,WAAW,CAACc,mBAAZ,GAAkC,IAAlC;AACD;;AAED,aAAOd,WAAP;AACD;;;sCAEiB;AAAA,UACTV,EADS,GACH,KAAKC,OADF,CACTD,EADS;AAAA,yBAEoB,KAAKa,KAFzB;AAAA,UAETmD,WAFS,gBAETA,WAFS;AAAA,UAEIC,MAFJ,gBAEIA,MAFJ;AAAA,UAEYxF,IAFZ,gBAEYA,IAFZ;AAIhB,WAAKyB,QAAL,CAAc;AACZiC,QAAAA,cAAc,EAAE,IAAI+B,eAAJ,CAAclE,EAAd;AACdmE,UAAAA,KAAK,EAAEH,WADO;AAEdI,UAAAA,MAAM,EAAEJ,WAFM;AAGdC,UAAAA,MAAM,EAANA,MAHc;AAIdxF,UAAAA,IAAI,EAAJA;AAJc,WAKXV,eALW,EADJ;AAQZuE,QAAAA,iBAAiB,EAAE,IAAI4B,eAAJ,CAAclE,EAAd;AAAmBiE,UAAAA,MAAM,EAANA,MAAnB;AAA2BxF,UAAAA,IAAI,EAAJA;AAA3B,WAAoCV,eAApC;AARP,OAAd;AAUD;;;uCAEkB;AACjB,UAAMsG,gBAAgB,GAAG,KAAKC,mBAAL,EAAzB;AACAD,MAAAA,gBAAgB,CAACE,GAAjB,CAAqB;AACnBtB,QAAAA,SAAS,EAAE;AAACuB,UAAAA,IAAI,EAAE,CAAP;AAAU/F,UAAAA,IAAI,MAAd;AAA2BgG,UAAAA,QAAQ,EAAE;AAArC,SADQ;AAEnBC,QAAAA,OAAO,EAAE;AAACF,UAAAA,IAAI,EAAE,CAAP;AAAUC,UAAAA,QAAQ,EAAE;AAApB;AAFU,OAArB;AAIA,WAAKvE,QAAL,CAAc;AAACyE,QAAAA,qBAAqB,EAAE;AAAxB,OAAd;AACD;;;0CAEqB;AAAA,UACb3E,EADa,GACP,KAAKC,OADE,CACbD,EADa;AAEpB,UAAMgE,WAAW,GAAGhC,IAAI,CAACjD,GAAL,CAASlB,OAAT,EAAkB,yBAAcmC,EAAd,OAAlB,CAApB;AACA,UAAM4E,kBAAkB,GAAG,uBAAY5E,EAAZ,EAAgBP,eAASoF,wBAAzB,CAA3B;;AAHoB,8BAIG,yCAAiB;AAAC7E,QAAAA,EAAE,EAAFA,EAAD;AAAK4E,QAAAA,kBAAkB,EAAlBA;AAAL,OAAjB,CAJH;AAAA,UAIbX,MAJa,qBAIbA,MAJa;AAAA,UAILxF,IAJK,qBAILA,IAJK;;AAKpB,UAAMmD,YAAY,GAAGgD,kBAAkB,GAAG,CAAH,GAAO,IAAI,GAAlD;AACA,WAAK1E,QAAL,CAAc;AAAC8D,QAAAA,WAAW,EAAXA,WAAD;AAAcC,QAAAA,MAAM,EAANA,MAAd;AAAsBxF,QAAAA,IAAI,EAAJA,IAAtB;AAA4BmD,QAAAA,YAAY,EAAZA;AAA5B,OAAd;;AACA,UAAI,CAACgD,kBAAL,EAAyB;AACvBxE,mBAAI0E,IAAJ,yBAEI,KAAKxE,EAFT;AAKD;AACF;;;8CAE2C;AAAA,UAApByE,aAAoB,uEAAJ,EAAI;AAAA,UACnC/E,EADmC,GAC7B,KAAKC,OADwB,CACnCD,EADmC;AAAA,UAErCuD,gBAFqC,GAEjB,KAAK1C,KAFY,CAErC0C,gBAFqC;AAAA,UAGnCpB,cAHmC,GAGjB,KAAKtB,KAHY,CAGnCsB,cAHmC;;AAI1C,UAAIoB,gBAAJ,EAAsB;AACpBA,QAAAA,gBAAgB,UAAhB;AACD;;AACD,UAAMyB,OAAO,GAAG,0BACd;AACEC,QAAAA,EAAE,EAAEC,qBADN;AAEEC,QAAAA,GAAG,EAAEC;AAFP,OADc,EAKdL,aALc,CAAhB;AAQAxB,MAAAA,gBAAgB,GAAG,IAAI8B,eAAJ,CAAcrF,EAAd;AACjBM,QAAAA,EAAE,YAAK,KAAKA,EAAV,uBADe;AAEjBgF,QAAAA,YAAY,EAAE,CAFG;AAGjBC,QAAAA,cAAc,EAAEpD,cAHC;AAIjBqD,QAAAA,qBAAqB,EAAE;AAJN,SAKdR,OALc,EAAnB;AAOA,WAAK9E,QAAL,CAAc;AAACqD,QAAAA,gBAAgB,EAAhBA;AAAD,OAAd;AACD;;;sCAEiB;AAAA,UACTvD,EADS,GACH,KAAKC,OADF,CACTD,EADS;;AAEhB,WAAKyF,eAAL;;AAFgB,yBAGyC,KAAK5E,KAH9C;AAAA,UAGTmD,WAHS,gBAGTA,WAHS;AAAA,UAGI7B,cAHJ,gBAGIA,cAHJ;AAAA,UAGoBG,iBAHpB,gBAGoBA,iBAHpB;;AAIhB,WAAKoD,uBAAL;;AACA,UAAMlC,kBAAkB,GAAG,IAAI6B,eAAJ,CAAcrF,EAAd,EAAkB;AAC3CM,QAAAA,EAAE,YAAK,KAAKA,EAAV,2BADyC;AAE3CqF,QAAAA,eAAe,EAAE;AACfC,UAAAA,SAAS,EAAEzD;AADI,SAF0B;AAK3CoD,QAAAA,cAAc,EAAEjD,iBAL2B;AAM3CkD,QAAAA,qBAAqB,EAAE,YANoB;AAO3CP,QAAAA,EAAE,EAAEY,iBAPuC;AAQ3CV,QAAAA,GAAG,EAAEW,iBARsC;AAS3CR,QAAAA,YAAY,EAAEtB,WAAW,GAAGA;AATe,OAAlB,CAA3B;AAYA,WAAK9D,QAAL,CAAc;AACZiC,QAAAA,cAAc,EAAdA,cADY;AAEZG,QAAAA,iBAAiB,EAAjBA,iBAFY;AAGZkB,QAAAA,kBAAkB,EAAlBA,kBAHY;AAIZtB,QAAAA,IAAI,EAAE,IAJM;AAKZE,QAAAA,iBAAiB,EAAE,IAAI2D,YAAJ,CAAW/F,EAAX,EAAe;AAChCgG,UAAAA,UAAU,EAAE,EADoB;AAEhCvB,UAAAA,QAAQ,EAAE;AAACD,YAAAA,IAAI,EAAE;AAAP;AAFsB,SAAf,CALP;AASZnC,QAAAA,iBAAiB,EAAE,IAAI0D,YAAJ,CAAW/F,EAAX,EAAe;AAChCgG,UAAAA,UAAU,EAAE,EADoB;AAEhCvB,UAAAA,QAAQ,EAAE;AAACD,YAAAA,IAAI,EAAE;AAAP;AAFsB,SAAf;AATP,OAAd;AAcD;;;kCAGaO,a,EAAe;AAE3B,WAAKW,uBAAL,CAA6BX,aAA7B;AACD;;;4CAEuB;AAAA,UACfvB,kBADe,GACO,KAAK3C,KADZ,CACf2C,kBADe;AAEtBA,MAAAA,kBAAkB,CAACyC,GAAnB,CAAuB;AACrBhI,QAAAA,UAAU,EAAE;AACViI,UAAAA,KAAK,EAAE,IADG;AAEVC,UAAAA,SAAS,EAAE,KAFD;AAGVC,UAAAA,SAAS,EAAE,MAHD;AAIVC,UAAAA,aAAa;AAJH;AADS,OAAvB;AAQD;;;oCAGkC;AAAA,UAArBC,WAAqB,uEAAP,KAAO;AAAA,UAC1B3E,QAD0B,GACd,KAAK1B,OADS,CAC1B0B,QAD0B;AAKjC,UAAM4E,eAAe,GAAG,CACtB5E,QAAQ,CAAC6E,SAAT,CAAmB,CAAC,CAAD,EAAI,CAAJ,CAAnB,CADsB,EAEtB7E,QAAQ,CAAC6E,SAAT,CAAmB,CAAC7E,QAAQ,CAACwC,KAAV,EAAiB,CAAjB,CAAnB,CAFsB,EAGtBxC,QAAQ,CAAC6E,SAAT,CAAmB,CAAC7E,QAAQ,CAACwC,KAAV,EAAiBxC,QAAQ,CAACyC,MAA1B,CAAnB,CAHsB,EAItBzC,QAAQ,CAAC6E,SAAT,CAAmB,CAAC,CAAD,EAAI7E,QAAQ,CAACyC,MAAb,CAAnB,CAJsB,EAKtBrC,GALsB,CAKlB,UAAA0E,CAAC;AAAA,eAAIA,CAAC,CAAC1E,GAAF,CAAMC,IAAI,CAAC0E,MAAX,CAAJ;AAAA,OALiB,CAAxB;AAQA,UAAMC,kBAAkB,GAAG,kCAAUJ,eAAV,CAA3B;AAEA,UAAMK,QAAQ,GAAG;AAACD,QAAAA,kBAAkB,EAAlBA,kBAAD;AAAqBJ,QAAAA,eAAe,EAAfA;AAArB,OAAjB;AACA,UAAItF,aAAa,GAAG,KAApB;;AAEA,UACEqF,WAAW,IACX,CAAC,KAAKzF,KAAL,CAAWgG,WADZ,IAEA,CAAC,sCAAc,KAAKhG,KAAL,CAAWgG,WAAzB,EAAsCF,kBAAtC,CAHH,EAIE;AAGA,YAAMG,kBAAkB,GAAG,KAAKC,oBAAL,CAA0BJ,kBAA1B,CAA3B;;AAGA,YAAME,WAAW,GAAG,KAAKG,oBAAL,CAA0BF,kBAA1B,CAApB;;AAGA,YAAI,KAAKhH,KAAL,CAAW+C,gBAAX,KAAgCC,yBAAkBmE,MAAtD,EAA8D;AAC5DJ,UAAAA,WAAW,CAAC,CAAD,CAAX,GAAiB7E,IAAI,CAAC/C,GAAL,CAAS4H,WAAW,CAAC,CAAD,CAApB,EAAyB,CAAC,SAA1B,CAAjB;AACAA,UAAAA,WAAW,CAAC,CAAD,CAAX,GAAiB7E,IAAI,CAACjD,GAAL,CAAS8H,WAAW,CAAC,CAAD,CAApB,EAAyB,SAAzB,CAAjB;AACAA,UAAAA,WAAW,CAAC,CAAD,CAAX,GAAiB7E,IAAI,CAAC/C,GAAL,CAAS4H,WAAW,CAAC,CAAD,CAApB,EAAyB,CAAC,GAA1B,CAAjB;AACAA,UAAAA,WAAW,CAAC,CAAD,CAAX,GAAiB7E,IAAI,CAACjD,GAAL,CAAS8H,WAAW,CAAC,CAAD,CAApB,EAAyB,GAAzB,CAAjB;AACD;;AAGD,YAAMK,sBAAsB,GAAG,KAAKH,oBAAL,CAA0BF,WAA1B,CAA/B;;AAEAD,QAAAA,QAAQ,CAACC,WAAT,GAAuBA,WAAvB;AACAD,QAAAA,QAAQ,CAACM,sBAAT,GAAkCA,sBAAlC;AAEAjG,QAAAA,aAAa,GAAG,IAAhB;AACD;;AACD,WAAKf,QAAL,CAAc0G,QAAd;AACA,aAAO3F,aAAP;AACD;;;oDAE+B;AAAA,yBAO1B,KAAKJ,KAPqB;AAAA,UAG5BuB,iBAH4B,gBAG5BA,iBAH4B;AAAA,UAI5BC,iBAJ4B,gBAI5BA,iBAJ4B;AAAA,UAK5B6E,sBAL4B,gBAK5BA,sBAL4B;AAAA,UAM5BX,eAN4B,gBAM5BA,eAN4B;AAAA,UASvB5E,QATuB,GASX,KAAK1B,OATM,CASvB0B,QATuB;AAW9BS,MAAAA,iBAAiB,CAAC+E,OAAlB,CAA0B,qCAAaZ,eAAb,EAA8B,CAA9B,CAA1B;AAEA,UAAMa,aAAa,GAAGb,eAAe,CAACxE,GAAhB,CAAoB,UAAA0E,CAAC;AAAA,eACzC,8CAAsB9E,QAAQ,CAAC0F,eAAT,CAAyBZ,CAAzB,CAAtB,EAAmDS,sBAAnD,CADyC;AAAA,OAArB,CAAtB;AAGA7E,MAAAA,iBAAiB,CAAC8E,OAAlB,CAA0B,qCAAaC,aAAb,EAA4B,CAA5B,CAA1B;AACD;;;wCAEmBxG,I,EAAM;AAAA,UACjB1B,UADiB,GACH0B,IAAI,CAACd,KADF,CACjBZ,UADiB;AAAA,UAEnBqD,YAFmB,GAEH,KAAK1B,KAFF,CAEnB0B,YAFmB;AAGxB,UAAM+E,MAAM,GAAG,uCAAsBpI,UAAtB,EAAkC,KAAlC,EAAyCqI,UAAzC,CAAf;;AAEA,UAAIhF,YAAJ,EAAkB;AAChBA,QAAAA,YAAY,CAACiF,YAAb,CAA0B;AACxB3H,UAAAA,IAAI,EAAEyH,MADkB;AAExBnD,UAAAA,KAAK,EAAEjF,UAAU,CAACuI;AAFM,SAA1B;AAID,OALD,MAKO;AACLlF,QAAAA,YAAY,GAAG,IAAI2B,eAAJ,CAAc,KAAKjE,OAAL,CAAaD,EAA3B;AACbH,UAAAA,IAAI,EAAEyH,MADO;AAEbnD,UAAAA,KAAK,EAAEjF,UAAU,CAACuI,MAFL;AAGbrD,UAAAA,MAAM,EAAE;AAHK,WAIVrG,eAJU,EAAf;AAMD;;AACD,WAAKmC,QAAL,CAAc;AAACqC,QAAAA,YAAY,EAAZA;AAAD,OAAd;AACD;;;uCAEkB;AAAA;;AAAA,UACVvD,YADU,GACM,KAAKc,KADX,CACVd,YADU;AAAA,yBAEkE,KAAK6B,KAFvE;AAAA,UAEV0C,gBAFU,gBAEVA,gBAFU;AAAA,UAEQsD,WAFR,gBAEQA,WAFR;AAAA,UAEqB7C,WAFrB,gBAEqBA,WAFrB;AAAA,UAEkC7B,cAFlC,gBAEkCA,cAFlC;AAAA,UAEkDP,YAFlD,gBAEkDA,YAFlD;AAGjB,WAAKf,KAAL,CAAWU,gBAAX,GAA8B,KAA9B;;AAGA,UAAMmG,YAAY,GAAG,KAAKX,oBAAL,CAA0BF,WAA1B,EAAuC;AAC1Dc,QAAAA,wBAAwB,EAAE;AADgC,OAAvC,CAArB;;AAIA,UAAMC,QAAQ,GAAG;AACf5I,QAAAA,YAAY,EAAZA,YADe;AAEf0I,QAAAA,YAAY,EAAZA,YAFe;AAGfG,QAAAA,YAAY,EAAE7D,WAHC;AAIfpC,QAAAA,YAAY,EAAZA;AAJe,OAAjB;AAQA2B,MAAAA,gBAAgB,CAACuE,MAAjB,CAAwB;AACtBxC,QAAAA,YAAY,EAAE,KAAKyC,eAAL;AADQ,OAAxB;AAGAxE,MAAAA,gBAAgB,CAAC0C,GAAjB,CAAqB;AACnB2B,QAAAA,QAAQ,EAARA,QADmB;AAEnB3J,QAAAA,UAAU,EAAE;AACViI,UAAAA,KAAK,EAAE,IADG;AAEVC,UAAAA,SAAS,EAAE,KAFD;AAGVC,UAAAA,SAAS,EAAE,MAHD;AAIVC,UAAAA,aAAa;AAJH,SAFO;AAQnB2B,QAAAA,iBAAiB,EAAE,IARA;AASnBhF,QAAAA,UAAU,EAAE,KAAKiF,aAAL,EATO;AAUnBC,QAAAA,cAAc,EAAE,KAAKC,iBAAL;AAVG,OAArB;;AAYA,WAAKC,qBAAL;;AAGAjG,MAAAA,cAAc,CAACkG,aAAf;AAID;;;gDAE4C;AAAA,UAAnBC,SAAmB,uEAAP,KAAO;AAAA,UACtChH,WADsC,GACvB,KAAKT,KADkB,CACtCS,WADsC;;AAG3C,UAAIgH,SAAJ,EAAe;AACbhH,QAAAA,WAAW,GAAG,IAAd;;AAEA,aAAKJ,aAAL,CAAmB,IAAnB;;AACA,aAAKC,6BAAL;;AACA,aAAKjB,QAAL,CAAc;AAACqB,UAAAA,gBAAgB,EAAE;AAAnB,SAAd;AACD,OAND,MAMO;AACL,aAAKrB,QAAL,CAAc;AAACqB,UAAAA,gBAAgB,EAAE;AAAnB,SAAd;AACAF,QAAAA,YAAY,CAACC,WAAD,CAAZ;AACAA,QAAAA,WAAW,GAAGiH,UAAU,CAAC,KAAK9G,yBAAL,CAA+B+G,IAA/B,CAAoC,IAApC,EAA0C,IAA1C,CAAD,EAAkD1K,aAAlD,CAAxB;AACD;;AAED,WAAKoC,QAAL,CAAc;AAACoB,QAAAA,WAAW,EAAXA;AAAD,OAAd;AACD;;;yCAKoBuF,W,EAAwB;AAAA,UAAXjG,IAAW,uEAAJ,EAAI;AAAA,kCACAA,IADA,CACpC+G,wBADoC;AAAA,UACpCA,wBADoC,sCACT,KADS;;AAAA,yDAEAd,WAFA;AAAA,UAEpC4B,OAFoC;AAAA,UAE3BC,MAF2B;AAAA,UAEnBC,OAFmB;AAAA,UAEVC,MAFU;;AAAA,UAGpCjH,QAHoC,GAGxB,KAAK1B,OAHmB,CAGpC0B,QAHoC;AAAA,UAIpCqC,WAJoC,GAIrB,KAAKnD,KAJgB,CAIpCmD,WAJoC;AAAA,UAKpCnB,gBALoC,GAKhB,KAAK/C,KALW,CAKpC+C,gBALoC;AAO3C,UAAMgG,UAAU,GACdlB,wBAAwB,KACvB9E,gBAAgB,KAAKC,yBAAkBgG,cAAvC,IACCjG,gBAAgB,KAAKC,yBAAkBiG,aAFjB,CAD1B;AAIA,UAAMC,kBAAkB,GAAGH,UAAU,GACjClH,QAAQ,CAAC0F,eAAT,CAAyB,KAAKvH,KAAL,CAAWmJ,gBAApC,CADiC,GAEjC,CAAC,CAAD,EAAI,CAAJ,CAFJ;AAGA,UAAMzE,IAAI,GAAIR,WAAW,GAAGpG,UAAf,GAA6B+D,QAAQ,CAACG,KAAnD;AAEA,UAAIoH,gBAAJ;AACA,UAAIC,cAAJ;;AAGA,UAAIxB,wBAAwB,IAAI,CAACkB,UAAjC,EAA6C;AAC3CK,QAAAA,gBAAgB,GAAG,KAAK7B,eAAL,CAAqB,CAACoB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAArB,CAAnB;AACAS,QAAAA,cAAc,GAAG,KAAK9B,eAAL,CAAqB,CAACsB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAArB,CAAjB;AACD,OAHD,MAGO;AACLM,QAAAA,gBAAgB,GAAGvH,QAAQ,CAAC0F,eAAT,CAAyB,CAACoB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAAzB,CAAnB;AACAS,QAAAA,cAAc,GAAGxH,QAAQ,CAAC0F,eAAT,CAAyB,CAACsB,OAAD,EAAUC,MAAV,EAAkB,CAAlB,CAAzB,CAAjB;AACD;;AAED,aAAO,2CACL,CACEM,gBAAgB,CAAC,CAAD,CAAhB,GAAsBF,kBAAkB,CAAC,CAAD,CAD1C,EAEEE,gBAAgB,CAAC,CAAD,CAAhB,GAAsBF,kBAAkB,CAAC,CAAD,CAF1C,EAGEG,cAAc,CAAC,CAAD,CAAd,GAAoBH,kBAAkB,CAAC,CAAD,CAHxC,EAIEG,cAAc,CAAC,CAAD,CAAd,GAAoBH,kBAAkB,CAAC,CAAD,CAJxC,CADK,EAOLxE,IAPK,EAQLA,IARK,CAAP;AAUD;;;yCAIoBkD,Y,EAAc;AAAA,0DACAA,YADA;AAAA,UAC1B0B,IAD0B;AAAA,UACpBC,IADoB;AAAA,UACdC,IADc;AAAA,UACRC,IADQ;;AAAA,UAE1B5H,QAF0B,GAEd,KAAK1B,OAFS,CAE1B0B,QAF0B;AAGjC,UAAM6H,eAAe,GAAG7H,QAAQ,CAAC8H,iBAAT,CAA2B,CAACL,IAAD,EAAOC,IAAP,CAA3B,CAAxB;AACA,UAAMK,aAAa,GAAG/H,QAAQ,CAAC8H,iBAAT,CAA2B,CAACH,IAAD,EAAOC,IAAP,CAA3B,CAAtB;AAEA,aAAOC,eAAe,CAACG,KAAhB,CAAsB,CAAtB,EAAyB,CAAzB,EAA4BC,MAA5B,CAAmCF,aAAa,CAACC,KAAd,CAAoB,CAApB,EAAuB,CAAvB,CAAnC,CAAP;AACD;;;EAxeuCE,4B;;;AA2e1C9J,YAAY,CAAC+J,SAAb,GAAyB,cAAzB;AACA/J,YAAY,CAACxB,YAAb,GAA4BA,YAA5B","sourcesContent":["// Copyright (c) 2015 - 2019 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global setTimeout clearTimeout */\nimport GL from '@luma.gl/constants';\nimport {\n  getBounds,\n  boundsContain,\n  packVertices,\n  scaleToAspectRatio,\n  getTextureCoordinates,\n  getTextureParams\n} from './heatmap-layer-utils';\nimport {Buffer, Texture2D, Transform, getParameters, FEATURES, hasFeatures} from '@luma.gl/core';\nimport {\n  AttributeManager,\n  COORDINATE_SYSTEM,\n  log,\n  _mergeShaders as mergeShaders\n} from '@deck.gl/core';\nimport TriangleLayer from './triangle-layer';\nimport AggregationLayer from '../aggregation-layer';\nimport {defaultColorRange, colorRangeToFlatArray} from '../utils/color-utils';\nimport weights_vs from './weights-vs.glsl';\nimport weights_fs from './weights-fs.glsl';\nimport vs_max from './max-vs.glsl';\nimport fs_max from './max-fs.glsl';\n\nconst RESOLUTION = 2; // (number of common space pixels) / (number texels)\nconst SIZE_2K = 2048;\nconst ZOOM_DEBOUNCE = 500; // milliseconds\nconst TEXTURE_OPTIONS = {\n  mipmaps: false,\n  parameters: {\n    [GL.TEXTURE_MAG_FILTER]: GL.LINEAR,\n    [GL.TEXTURE_MIN_FILTER]: GL.LINEAR,\n    [GL.TEXTURE_WRAP_S]: GL.CLAMP_TO_EDGE,\n    [GL.TEXTURE_WRAP_T]: GL.CLAMP_TO_EDGE\n  },\n  dataFormat: GL.RGBA\n};\nconst DEFAULT_COLOR_DOMAIN = [0, 0];\nconst AGGREGATION_MODE = {\n  SUM: 0,\n  MEAN: 1\n};\n\nconst defaultProps = {\n  getPosition: {type: 'accessor', value: x => x.position},\n  getWeight: {type: 'accessor', value: 1},\n  intensity: {type: 'number', min: 0, value: 1},\n  radiusPixels: {type: 'number', min: 1, max: 100, value: 50},\n  colorRange: defaultColorRange,\n  threshold: {type: 'number', min: 0, max: 1, value: 0.05},\n  colorDomain: {type: 'array', value: null, optional: true},\n  // 'SUM' or 'MEAN'\n  aggregation: 'SUM'\n};\n\nconst REQUIRED_FEATURES = [\n  FEATURES.BLEND_EQUATION_MINMAX, // max weight calculation\n  FEATURES.TEXTURE_FLOAT // weight-map as texture\n  // FEATURES.FLOAT_BLEND, // implictly supported when TEXTURE_FLOAT is supported\n];\n\nconst DIMENSIONS = {\n  data: {\n    props: ['radiusPixels']\n  }\n};\n\nexport default class HeatmapLayer extends AggregationLayer {\n  initializeState() {\n    const {gl} = this.context;\n    if (!hasFeatures(gl, REQUIRED_FEATURES)) {\n      this.setState({supported: false});\n      log.error(`HeatmapLayer: ${this.id} is not supported on this browser`)();\n      return;\n    }\n    super.initializeState(DIMENSIONS);\n    this.setState({supported: true});\n    this._setupTextureParams();\n    this._setupAttributes();\n    this._setupResources();\n  }\n\n  shouldUpdateState({changeFlags}) {\n    // Need to be updated when viewport changes\n    return changeFlags.somethingChanged;\n  }\n\n  /* eslint-disable max-statements,complexity */\n  updateState(opts) {\n    if (!this.state.supported) {\n      return;\n    }\n    super.updateState(opts);\n    const {props, oldProps} = opts;\n    const changeFlags = this._getChangeFlags(opts);\n\n    if (changeFlags.viewportChanged) {\n      changeFlags.boundsChanged = this._updateBounds();\n      this._updateTextureRenderingBounds();\n    }\n\n    if (changeFlags.dataChanged || changeFlags.boundsChanged) {\n      // Update weight map immediately\n      clearTimeout(this.state.updateTimer);\n      this.setState({isWeightMapDirty: true});\n    } else if (changeFlags.viewportZoomChanged) {\n      // Update weight map when zoom stops\n      this._debouncedUpdateWeightmap();\n    }\n\n    if (props.colorRange !== oldProps.colorRange) {\n      this._updateColorTexture(opts);\n    }\n\n    if (oldProps.colorDomain !== props.colorDomain || changeFlags.viewportChanged) {\n      const {viewport} = this.context;\n      const {weightsScale} = this.state;\n      const domainScale = (viewport ? 1024 / viewport.scale : 1) * weightsScale;\n      const colorDomain = props.colorDomain\n        ? props.colorDomain.map(x => x * domainScale)\n        : DEFAULT_COLOR_DOMAIN;\n      if (colorDomain[1] > 0 && weightsScale < 1) {\n        // Hack - when low precision texture is used, aggregated weights are in the [0, 1]\n        // range. Scale colorDomain to fit.\n        const max = Math.min(colorDomain[1], 1);\n        colorDomain[0] *= max / colorDomain[1];\n        colorDomain[1] = max;\n      }\n      this.setState({colorDomain});\n    }\n\n    if (this.state.isWeightMapDirty) {\n      this._updateWeightmap();\n    }\n\n    this.setState({zoom: opts.context.viewport.zoom});\n  }\n  /* eslint-enable max-statements,complexity */\n\n  renderLayers() {\n    if (!this.state.supported) {\n      return [];\n    }\n    const {\n      weightsTexture,\n      triPositionBuffer,\n      triTexCoordBuffer,\n      maxWeightsTexture,\n      colorTexture,\n      colorDomain\n    } = this.state;\n    const {updateTriggers, intensity, threshold, aggregation} = this.props;\n\n    const TriangleLayerClass = this.getSubLayerClass('triangle', TriangleLayer);\n\n    return new TriangleLayerClass(\n      this.getSubLayerProps({\n        id: 'triangle-layer',\n        updateTriggers\n      }),\n      {\n        // position buffer is filled with world coordinates generated from viewport.unproject\n        // i.e. LNGLAT if geospatial, CARTESIAN otherwise\n        coordinateSystem: COORDINATE_SYSTEM.DEFAULT,\n        data: {\n          attributes: {\n            positions: triPositionBuffer,\n            texCoords: triTexCoordBuffer\n          }\n        },\n        vertexCount: 4,\n        maxTexture: maxWeightsTexture,\n        colorTexture,\n        aggregationMode: AGGREGATION_MODE[aggregation] || 0,\n        texture: weightsTexture,\n        intensity,\n        threshold,\n        colorDomain\n      }\n    );\n  }\n\n  finalizeState() {\n    super.finalizeState();\n    const {\n      weightsTransform,\n      weightsTexture,\n      maxWeightTransform,\n      maxWeightsTexture,\n      triPositionBuffer,\n      triTexCoordBuffer,\n      colorTexture,\n      updateTimer\n    } = this.state;\n    /* eslint-disable no-unused-expressions */\n    weightsTransform && weightsTransform.delete();\n    weightsTexture && weightsTexture.delete();\n    maxWeightTransform && maxWeightTransform.delete();\n    maxWeightsTexture && maxWeightsTexture.delete();\n    triPositionBuffer && triPositionBuffer.delete();\n    triTexCoordBuffer && triTexCoordBuffer.delete();\n    colorTexture && colorTexture.delete();\n    updateTimer && clearTimeout(updateTimer);\n    /* eslint-enable no-unused-expressions */\n  }\n\n  // PRIVATE\n\n  // override Composite layer private method to create AttributeManager instance\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats\n    });\n  }\n\n  _getChangeFlags(opts) {\n    const changeFlags = {};\n    const {dimensions} = this.state;\n    changeFlags.dataChanged =\n      this.isAttributeChanged() || // if any attribute is changed\n      this.isAggregationDirty(opts, {\n        compareAll: true,\n        dimension: dimensions.data\n      });\n    changeFlags.viewportChanged = opts.changeFlags.viewportChanged;\n\n    const {zoom} = this.state;\n    if (!opts.context.viewport || opts.context.viewport.zoom !== zoom) {\n      changeFlags.viewportZoomChanged = true;\n    }\n\n    return changeFlags;\n  }\n\n  _createTextures() {\n    const {gl} = this.context;\n    const {textureSize, format, type} = this.state;\n\n    this.setState({\n      weightsTexture: new Texture2D(gl, {\n        width: textureSize,\n        height: textureSize,\n        format,\n        type,\n        ...TEXTURE_OPTIONS\n      }),\n      maxWeightsTexture: new Texture2D(gl, {format, type, ...TEXTURE_OPTIONS}) // 1 X 1 texture,\n    });\n  }\n\n  _setupAttributes() {\n    const attributeManager = this.getAttributeManager();\n    attributeManager.add({\n      positions: {size: 3, type: GL.DOUBLE, accessor: 'getPosition'},\n      weights: {size: 1, accessor: 'getWeight'}\n    });\n    this.setState({positionAttributeName: 'positions'});\n  }\n\n  _setupTextureParams() {\n    const {gl} = this.context;\n    const textureSize = Math.min(SIZE_2K, getParameters(gl, gl.MAX_TEXTURE_SIZE));\n    const floatTargetSupport = hasFeatures(gl, FEATURES.COLOR_ATTACHMENT_RGBA32F);\n    const {format, type} = getTextureParams({gl, floatTargetSupport});\n    const weightsScale = floatTargetSupport ? 1 : 1 / 255;\n    this.setState({textureSize, format, type, weightsScale});\n    if (!floatTargetSupport) {\n      log.warn(\n        `HeatmapLayer: ${\n          this.id\n        } rendering to float texture not supported, fallingback to low precession format`\n      )();\n    }\n  }\n\n  _createWeightsTransform(shaderOptions = {}) {\n    const {gl} = this.context;\n    let {weightsTransform} = this.state;\n    const {weightsTexture} = this.state;\n    if (weightsTransform) {\n      weightsTransform.delete();\n    }\n    const shaders = mergeShaders(\n      {\n        vs: weights_vs,\n        _fs: weights_fs\n      },\n      shaderOptions\n    );\n\n    weightsTransform = new Transform(gl, {\n      id: `${this.id}-weights-transform`,\n      elementCount: 1,\n      _targetTexture: weightsTexture,\n      _targetTextureVarying: 'weightsTexture',\n      ...shaders\n    });\n    this.setState({weightsTransform});\n  }\n\n  _setupResources() {\n    const {gl} = this.context;\n    this._createTextures();\n    const {textureSize, weightsTexture, maxWeightsTexture} = this.state;\n    this._createWeightsTransform();\n    const maxWeightTransform = new Transform(gl, {\n      id: `${this.id}-max-weights-transform`,\n      _sourceTextures: {\n        inTexture: weightsTexture\n      },\n      _targetTexture: maxWeightsTexture,\n      _targetTextureVarying: 'outTexture',\n      vs: vs_max,\n      _fs: fs_max,\n      elementCount: textureSize * textureSize\n    });\n\n    this.setState({\n      weightsTexture,\n      maxWeightsTexture,\n      maxWeightTransform,\n      zoom: null,\n      triPositionBuffer: new Buffer(gl, {\n        byteLength: 48,\n        accessor: {size: 3}\n      }),\n      triTexCoordBuffer: new Buffer(gl, {\n        byteLength: 48,\n        accessor: {size: 2}\n      })\n    });\n  }\n\n  // overwrite super class method to update transform model\n  updateShaders(shaderOptions) {\n    // sahder params (modules, injects) changed, update model object\n    this._createWeightsTransform(shaderOptions);\n  }\n\n  _updateMaxWeightValue() {\n    const {maxWeightTransform} = this.state;\n    maxWeightTransform.run({\n      parameters: {\n        blend: true,\n        depthTest: false,\n        blendFunc: [GL.ONE, GL.ONE],\n        blendEquation: GL.MAX\n      }\n    });\n  }\n\n  // Computes world bounds area that needs to be processed for generate heatmap\n  _updateBounds(forceUpdate = false) {\n    const {viewport} = this.context;\n\n    // Unproject all 4 corners of the current screen coordinates into world coordinates (lng/lat)\n    // Takes care of viewport has non zero bearing/pitch (i.e axis not aligned with world coordiante system)\n    const viewportCorners = [\n      viewport.unproject([0, 0]),\n      viewport.unproject([viewport.width, 0]),\n      viewport.unproject([viewport.width, viewport.height]),\n      viewport.unproject([0, viewport.height])\n    ].map(p => p.map(Math.fround));\n\n    // #1: get world bounds for current viewport extends\n    const visibleWorldBounds = getBounds(viewportCorners); // TODO: Change to visible bounds\n\n    const newState = {visibleWorldBounds, viewportCorners};\n    let boundsChanged = false;\n\n    if (\n      forceUpdate ||\n      !this.state.worldBounds ||\n      !boundsContain(this.state.worldBounds, visibleWorldBounds)\n    ) {\n      // #2 : convert world bounds to common (Flat) bounds\n      // #3 : extend common bounds to match aspect ratio with viewport\n      const scaledCommonBounds = this._worldToCommonBounds(visibleWorldBounds);\n\n      // #4 :convert aligned common bounds to world bounds\n      const worldBounds = this._commonToWorldBounds(scaledCommonBounds);\n\n      // Clip webmercator projection limits\n      if (this.props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT) {\n        worldBounds[1] = Math.max(worldBounds[1], -85.051129);\n        worldBounds[3] = Math.min(worldBounds[3], 85.051129);\n        worldBounds[0] = Math.max(worldBounds[0], -360);\n        worldBounds[2] = Math.min(worldBounds[2], 360);\n      }\n\n      // #5: now convert world bounds to common using Layer's coordiante system and origin\n      const normalizedCommonBounds = this._worldToCommonBounds(worldBounds);\n\n      newState.worldBounds = worldBounds;\n      newState.normalizedCommonBounds = normalizedCommonBounds;\n\n      boundsChanged = true;\n    }\n    this.setState(newState);\n    return boundsChanged;\n  }\n\n  _updateTextureRenderingBounds() {\n    // Just render visible portion of the texture\n    const {\n      triPositionBuffer,\n      triTexCoordBuffer,\n      normalizedCommonBounds,\n      viewportCorners\n    } = this.state;\n\n    const {viewport} = this.context;\n\n    triPositionBuffer.subData(packVertices(viewportCorners, 3));\n\n    const textureBounds = viewportCorners.map(p =>\n      getTextureCoordinates(viewport.projectPosition(p), normalizedCommonBounds)\n    );\n    triTexCoordBuffer.subData(packVertices(textureBounds, 2));\n  }\n\n  _updateColorTexture(opts) {\n    const {colorRange} = opts.props;\n    let {colorTexture} = this.state;\n    const colors = colorRangeToFlatArray(colorRange, false, Uint8Array);\n\n    if (colorTexture) {\n      colorTexture.setImageData({\n        data: colors,\n        width: colorRange.length\n      });\n    } else {\n      colorTexture = new Texture2D(this.context.gl, {\n        data: colors,\n        width: colorRange.length,\n        height: 1,\n        ...TEXTURE_OPTIONS\n      });\n    }\n    this.setState({colorTexture});\n  }\n\n  _updateWeightmap() {\n    const {radiusPixels} = this.props;\n    const {weightsTransform, worldBounds, textureSize, weightsTexture, weightsScale} = this.state;\n    this.state.isWeightMapDirty = false;\n\n    // #5: convert world bounds to common using Layer's coordiante system and origin\n    const commonBounds = this._worldToCommonBounds(worldBounds, {\n      useLayerCoordinateSystem: true\n    });\n\n    const uniforms = {\n      radiusPixels,\n      commonBounds,\n      textureWidth: textureSize,\n      weightsScale\n    };\n    // Attribute manager sets data array count as instaceCount on model\n    // we need to set that as elementCount on 'weightsTransform'\n    weightsTransform.update({\n      elementCount: this.getNumInstances()\n    });\n    weightsTransform.run({\n      uniforms,\n      parameters: {\n        blend: true,\n        depthTest: false,\n        blendFunc: [GL.ONE, GL.ONE],\n        blendEquation: GL.FUNC_ADD\n      },\n      clearRenderTarget: true,\n      attributes: this.getAttributes(),\n      moduleSettings: this.getModuleSettings()\n    });\n    this._updateMaxWeightValue();\n\n    // reset filtering parameters (TODO: remove once luma issue#1193 is fixed)\n    weightsTexture.setParameters({\n      [GL.TEXTURE_MAG_FILTER]: GL.LINEAR,\n      [GL.TEXTURE_MIN_FILTER]: GL.LINEAR\n    });\n  }\n\n  _debouncedUpdateWeightmap(fromTimer = false) {\n    let {updateTimer} = this.state;\n\n    if (fromTimer) {\n      updateTimer = null;\n      // update\n      this._updateBounds(true);\n      this._updateTextureRenderingBounds();\n      this.setState({isWeightMapDirty: true});\n    } else {\n      this.setState({isWeightMapDirty: false});\n      clearTimeout(updateTimer);\n      updateTimer = setTimeout(this._debouncedUpdateWeightmap.bind(this, true), ZOOM_DEBOUNCE);\n    }\n\n    this.setState({updateTimer});\n  }\n\n  // input: worldBounds: [minLong, minLat, maxLong, maxLat]\n  // input: opts.useLayerCoordinateSystem : layers coordiante system is used\n  // optput: commonBounds: [minX, minY, maxX, maxY] scaled to fit the current texture\n  _worldToCommonBounds(worldBounds, opts = {}) {\n    const {useLayerCoordinateSystem = false} = opts;\n    const [minLong, minLat, maxLong, maxLat] = worldBounds;\n    const {viewport} = this.context;\n    const {textureSize} = this.state;\n    const {coordinateSystem} = this.props;\n\n    const offsetMode =\n      useLayerCoordinateSystem &&\n      (coordinateSystem === COORDINATE_SYSTEM.LNGLAT_OFFSETS ||\n        coordinateSystem === COORDINATE_SYSTEM.METER_OFFSETS);\n    const offsetOriginCommon = offsetMode\n      ? viewport.projectPosition(this.props.coordinateOrigin)\n      : [0, 0];\n    const size = (textureSize * RESOLUTION) / viewport.scale;\n\n    let bottomLeftCommon;\n    let topRightCommon;\n\n    // Y-axis is flipped between World and Common bounds\n    if (useLayerCoordinateSystem && !offsetMode) {\n      bottomLeftCommon = this.projectPosition([minLong, minLat, 0]);\n      topRightCommon = this.projectPosition([maxLong, maxLat, 0]);\n    } else {\n      bottomLeftCommon = viewport.projectPosition([minLong, minLat, 0]);\n      topRightCommon = viewport.projectPosition([maxLong, maxLat, 0]);\n    }\n    // Ignore z component\n    return scaleToAspectRatio(\n      [\n        bottomLeftCommon[0] - offsetOriginCommon[0],\n        bottomLeftCommon[1] - offsetOriginCommon[1],\n        topRightCommon[0] - offsetOriginCommon[0],\n        topRightCommon[1] - offsetOriginCommon[1]\n      ],\n      size,\n      size\n    );\n  }\n\n  // input commonBounds: [xMin, yMin, xMax, yMax]\n  // output worldBounds: [minLong, minLat, maxLong, maxLat]\n  _commonToWorldBounds(commonBounds) {\n    const [xMin, yMin, xMax, yMax] = commonBounds;\n    const {viewport} = this.context;\n    const bottomLeftWorld = viewport.unprojectPosition([xMin, yMin]);\n    const topRightWorld = viewport.unprojectPosition([xMax, yMax]);\n\n    return bottomLeftWorld.slice(0, 2).concat(topRightWorld.slice(0, 2));\n  }\n}\n\nHeatmapLayer.layerName = 'HeatmapLayer';\nHeatmapLayer.defaultProps = defaultProps;\n"],"file":"heatmap-layer.js"}