{"version":3,"sources":["../../../src/geojson-layer/geojson-binary.js"],"names":["GEOM_TYPES","binaryToFeature","data","featureIdIndex","index","featureIds","value","indexOf","getPropertiesForIndex","binaryToFeatureForAccesor","featureIndex","startIndices","geometryIndex","propertiesIndex","numericPropsIndex","feature","properties","prop","numericProps","findIndexBinary","uniqueIdProperty","featureId","gt","findIndexByType","geomType","positions","length","propertyIndex","findIndex","elem","calculatePickingColors","geojsonBinary","encodePickingColor","pickingColors","points","lines","polygons","key","Uint8ClampedArray","pickingColor","i"],"mappings":"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","sourcesContent":["// This module implement some utility functions to work with\n// the geojson-binary format defined at loaders.gl:\n// https://github.com/visgl/loaders.gl/blob/master/modules/gis/docs/api-reference/geojson-to-binary.md\n\nconst GEOM_TYPES = ['points', 'lines', 'polygons'];\n\n/**\n * Return the feature for a given featureId index value\n *\n * @param {Object} data - The data in binary format\n * @param {Number} featureIdIndex - The requested picking index\n */\nexport function binaryToFeature(data, featureIdIndex) {\n  if (!data) {\n    return null;\n  }\n\n  const index = data.featureIds.value.indexOf(featureIdIndex);\n\n  if (index !== -1) {\n    return getPropertiesForIndex(data, featureIdIndex, index);\n  }\n\n  return null;\n}\n\n/**\n * Return the feature for an accesor\n *\n * @param {Object} data - The data in binary format\n * @param {Number} index - The requested index\n */\nexport function binaryToFeatureForAccesor(data, index) {\n  if (!data) {\n    return null;\n  }\n\n  const featureIndex = 'startIndices' in data ? data.startIndices[index] : index;\n  const geometryIndex = data.featureIds.value[featureIndex];\n\n  if (featureIndex !== -1) {\n    return getPropertiesForIndex(data, geometryIndex, featureIndex);\n  }\n\n  return null;\n}\n\nfunction getPropertiesForIndex(data, propertiesIndex, numericPropsIndex) {\n  const feature = {\n    properties: {...data.properties[propertiesIndex]}\n  };\n\n  for (const prop in data.numericProps) {\n    feature.properties[prop] = data.numericProps[prop].value[numericPropsIndex];\n  }\n\n  return feature;\n}\n\n/**\n * Return the index of feature (numericProps or featureIds) for given feature id\n * Example: findIndexBinary(data, 'id', 33) will return the index in the array of numericProps\n * of the feature 33.\n * @param {Object} data - The data in binary format\n * @param {String} uniqueIdProperty - Name of the unique id property\n * @param {Number} featureId - feature id to find\n */\nexport function findIndexBinary(data, uniqueIdProperty, featureId) {\n  if (!data) {\n    return -1;\n  }\n\n  for (const gt of GEOM_TYPES) {\n    const index = findIndexByType(data, uniqueIdProperty, featureId, gt);\n    if (index !== -1) {\n      return index;\n    }\n  }\n\n  return -1;\n}\n\nfunction findIndexByType(data, uniqueIdProperty, featureId, geomType) {\n  if (!data) {\n    return -1;\n  }\n\n  if (!(geomType in data) || !data[geomType].positions.value.length) return -1;\n\n  // Look for the uniqueIdProperty\n  let index = -1;\n  if (data[geomType].numericProps[uniqueIdProperty]) {\n    index = data[geomType].numericProps[uniqueIdProperty].value.indexOf(featureId);\n  } else {\n    const propertyIndex = data[geomType].properties.findIndex(\n      elem => elem[uniqueIdProperty] === featureId\n    );\n    index = data[geomType].featureIds.value.indexOf(propertyIndex);\n  }\n\n  return index;\n}\n\n// Custom picking color to keep binary indexes\nexport function calculatePickingColors(geojsonBinary, encodePickingColor) {\n  const pickingColors = {\n    points: null,\n    lines: null,\n    polygons: null\n  };\n  for (const key in pickingColors) {\n    const featureIds = geojsonBinary[key].featureIds.value;\n    pickingColors[key] = new Uint8ClampedArray(featureIds.length * 3);\n    const pickingColor = [];\n    for (let i = 0; i < featureIds.length; i++) {\n      encodePickingColor(featureIds[i], pickingColor);\n      pickingColors[key][i * 3 + 0] = pickingColor[0];\n      pickingColors[key][i * 3 + 1] = pickingColor[1];\n      pickingColors[key][i * 3 + 2] = pickingColor[2];\n    }\n  }\n\n  return pickingColors;\n}\n"],"file":"geojson-binary.js"}